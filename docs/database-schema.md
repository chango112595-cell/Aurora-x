# Aurora-X Database Schema Documentation

**Generated by Aurora Autonomous System**  
**Last Updated:** 2025-11-10

## Overview

Aurora-X uses a hybrid data storage approach with multiple persistence layers:

### Current Implementation

#### 1. **Drizzle ORM** (Primary SQL Database)
- **Configuration:** `drizzle.config.ts`
- **Status:** Configured but schema files not visible in main directory
- **Recommended Location:** `db/schema.ts` (to be created)

#### 2. **JSON File Storage** (Current)
Aurora currently uses JSON files for various data storage needs:

##### Knowledge & Intelligence
- `.aurora_knowledge/` - Task management and knowledge base
  - `*.flag` - Pending tasks
  - `*.completed` - Completed task records
  - `aurora_task_history.json` - Task execution history

##### Configuration & State
- `aurora_intelligence.json` (17 KB) - AI intelligence state
- `aurora_server_config.json` - Server configuration
- `aurora_supervisor_config.json` (1 KB) - Supervisor settings
- `.aurora_approvals.json` (1 KB) - Approval tracking
- `.aurora_grades.json` (2 KB) - Performance grades
- `.self_learning_state.json` (8 KB) - Self-learning progress

##### Corpus & Analysis
- `corpus.json` (4.5 MB) - Code corpus data
- `corpus1.json` (915 KB) - Additional corpus
- `aurora_analysis_results.json` (1.4 MB) - Analysis results

---

## Recommended Database Schema

### Core Tables (To Be Implemented)

#### `users`
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  username VARCHAR(255) UNIQUE NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  is_active BOOLEAN DEFAULT true
);
```

#### `sessions`
```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id INTEGER REFERENCES users(id),
  token VARCHAR(512) UNIQUE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP NOT NULL,
  ip_address VARCHAR(45),
  user_agent TEXT
);
```

#### `tasks`
```sql
CREATE TABLE tasks (
  id VARCHAR(32) PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  status VARCHAR(50) DEFAULT 'pending',
  priority VARCHAR(20) DEFAULT 'normal',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMP,
  created_by INTEGER REFERENCES users(id),
  task_type VARCHAR(50),
  metadata JSONB
);
```

#### `chat_messages`
```sql
CREATE TABLE chat_messages (
  id SERIAL PRIMARY KEY,
  session_id VARCHAR(255) NOT NULL,
  role VARCHAR(20) NOT NULL, -- 'user' or 'aurora'
  content TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  metadata JSONB,
  user_id INTEGER REFERENCES users(id)
);
```

#### `corpus_entries`
```sql
CREATE TABLE corpus_entries (
  id SERIAL PRIMARY KEY,
  func_name VARCHAR(255) NOT NULL,
  func_signature TEXT NOT NULL,
  snippet TEXT,
  score FLOAT,
  passed INTEGER,
  total INTEGER,
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  metadata JSONB,
  INDEX idx_func_name (func_name),
  INDEX idx_score (score),
  INDEX idx_timestamp (timestamp)
);
```

#### `service_health`
```sql
CREATE TABLE service_health (
  id SERIAL PRIMARY KEY,
  service_name VARCHAR(100) NOT NULL,
  port INTEGER NOT NULL,
  status VARCHAR(50) NOT NULL, -- 'running', 'stopped', 'error'
  last_check TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  response_time_ms INTEGER,
  error_message TEXT,
  metadata JSONB
);
```

#### `audit_log`
```sql
CREATE TABLE audit_log (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  action VARCHAR(100) NOT NULL,
  resource_type VARCHAR(50),
  resource_id VARCHAR(255),
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  metadata JSONB
);
```

---

## Migration Strategy

### Phase 1: Setup Database Infrastructure
1. Create database schema files in `db/schema.ts` using Drizzle ORM
2. Set up database connection pooling
3. Configure environment variables for database credentials
4. Create initial migrations

### Phase 2: Migrate JSON Data
1. Keep JSON files as backup during transition
2. Create migration scripts to transfer data:
   - Tasks: `.aurora_knowledge/*.completed` → `tasks` table
   - Corpus: `corpus.json` → `corpus_entries` table
   - Intelligence: `aurora_intelligence.json` → appropriate tables
3. Run migrations in stages with rollback capability

### Phase 3: Update Application Code
1. Update services to use database instead of JSON files
2. Add database query layers
3. Implement proper transaction handling
4. Add database indexing for performance

### Phase 4: Cleanup
1. Archive old JSON files
2. Remove JSON read/write code
3. Update documentation
4. Monitor performance and optimize queries

---

## Database Best Practices (To Implement)

### Connection Management
- Use connection pooling (pg-pool for Node.js, asyncpg for Python)
- Set appropriate pool sizes based on load
- Implement connection retry logic

### Performance
- Add indexes on frequently queried columns
- Use database-level constraints
- Implement query result caching where appropriate
- Monitor slow queries

### Security
- Use parameterized queries (prevent SQL injection)
- Implement role-based access control
- Encrypt sensitive data at rest
- Regular security audits

### Backup & Recovery
- Daily automated backups
- Point-in-time recovery capability
- Test restore procedures regularly
- Store backups in separate location

---

## Current Status

**Database Layer Maturity:** 20% ⭐⚪⚪⚪⚪

✅ **Implemented:**
- Drizzle ORM configuration exists
- JSON file-based storage working
- Data persistence operational

❌ **Missing:**
- Actual database schema files
- Migration scripts
- Connection pooling
- Backup procedures
- Query optimization

⚠️ **Needs Immediate Attention:**
1. Create `db/schema.ts` with Drizzle schema definitions
2. Set up database migrations
3. Implement backup strategy
4. Add database monitoring

---

## Next Steps

### Immediate (This Week)
1. Create `db/schema.ts` with core tables
2. Set up PostgreSQL or SQLite for development
3. Create first migration script
4. Test database connection

### Short-term (2-4 Weeks)
1. Migrate task data from JSON to database
2. Implement connection pooling
3. Add database health checks
4. Create backup scripts

### Long-term (1-2 Months)
1. Migrate all JSON data to database
2. Remove JSON file dependencies
3. Implement advanced features (full-text search, etc.)
4. Optimize query performance

---

## References

- **Drizzle ORM Documentation:** https://orm.drizzle.team/
- **PostgreSQL Documentation:** https://www.postgresql.org/docs/
- **Database Design Best Practices:** See internal docs

---

**Note:** This is a living document. As Aurora implements database features,
this document should be updated to reflect the current state.

**Aurora's Assessment:** Database layer is the foundation for scalability.
Priority should be given to implementing proper schema and migrations.
