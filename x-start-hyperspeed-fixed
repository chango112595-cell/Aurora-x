#!/usr/bin/env python3
"""
[POWER] AURORA NEXUS V3 - HYPER-SPEED LAUNCHER (FIXED) [POWER]
DEBUGGABLE | PORT-AWARE | FULL DIAGNOSTICS | 31 SYSTEMS
"""

import time
import subprocess
import os
import platform
import socket
import sys
import signal

print("=" * 80)
print("[POWER] AURORA NEXUS V3 - HYPER-SPEED ACTIVATION (DEBUGGABLE)")
print("=" * 80)
print("188 Capabilities | 31 Systems | SMART PORT MANAGEMENT | FULL DIAGNOSTICS")
print("=" * 80 + "\n")

script_dir = os.path.dirname(os.path.abspath(__file__))
os.chdir(script_dir)

IS_WINDOWS = platform.system() == "Windows"
PYTHON_CMD = "python" if IS_WINDOWS else "python3"

processes = []
successful_starts = []
failed_starts = []

def cleanup_existing_processes():
    """Kill any existing Aurora/Luminar processes"""
    print("[EMOJI] Cleaning up existing processes...")
    try:
        if IS_WINDOWS:
            os.system("taskkill /F /IM python.exe 2>nul")
        else:
            os.system("pkill -f 'python3.*aurora' 2>/dev/null || true")
            os.system("pkill -f 'python3.*luminar' 2>/dev/null || true")
        time.sleep(2)
        print("   [OK] Cleanup complete\n")
    except Exception as e:
        print(f"   [WARN]  Cleanup error (non-critical): {e}\n")

def check_port(port):
    """Check if port is available"""
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(1)
    try:
        result = sock.connect_ex(('127.0.0.1', port))
        sock.close()
        return result != 0  # 0 means port is in use, != 0 means available
    except:
        try:
            sock.close()
        except:
            pass
        return True

def start(cmd, name="Service", shell=False, critical=False, port=None):
    """Launch process with better error handling"""
    if port and not check_port(port):
        msg = f"[ERROR] {name}: Port {port} already in use"
        print(f"   {msg}")
        failed_starts.append((name, f"Port {port} occupied"))
        return None
    
    kwargs = {
        'stdout': subprocess.PIPE,
        'stderr': subprocess.PIPE,
        'text': True
    }

    if IS_WINDOWS:
        kwargs['creationflags'] = subprocess.CREATE_NEW_PROCESS_GROUP
        if shell:
            kwargs['shell'] = True
    else:
        kwargs['start_new_session'] = True

    try:
        proc = subprocess.Popen(cmd, **kwargs)
        processes.append((proc, name, critical))
        successful_starts.append(name)
        print(f"   [OK] {name}")
        return proc
    except Exception as e:
        msg = f"[ERROR] {name}: {str(e)[:50]}"
        print(f"   {msg}")
        failed_starts.append((name, str(e)))
        return None


# CLEANUP FIRST
cleanup_existing_processes()

# PHASE 0: NEXUS V3 MASTER ORCHESTRATOR
print("━" * 80)
print("[AURORA] PHASE 0: NEXUS V3 MASTER ORCHESTRATOR")
print("━" * 80)
start([PYTHON_CMD, "aurora_nexus_v3_universal.py", "--orchestration", "--daemon"],
      "Nexus V3 Master Orchestrator (Port 5031)", critical=True, port=5031)

# PHASE 1: CONSCIOUSNESS
print("\n━" * 80)
print("[BRAIN] PHASE 1: CONSCIOUSNESS & AWARENESS")
print("━" * 80)
if os.path.exists("aurora_consciousness_service.py"):
    start([PYTHON_CMD, "aurora_consciousness_service.py"],
          "Consciousness (Port 5009)", critical=True, port=5009)

# PHASE 2: INTELLIGENCE
print("\n━" * 80)
print("[POWER] PHASE 2: CORE INTELLIGENCE")
print("━" * 80)
if os.path.exists("aurora_tier_orchestrator.py"):
    start([PYTHON_CMD, "aurora_tier_orchestrator.py"],
          "Tier Orchestrator (Port 5010, 79 Tiers)", critical=True, port=5010)
if os.path.exists("aurora_intelligence_manager.py"):
    start([PYTHON_CMD, "aurora_intelligence_manager.py"],
          "Intelligence Manager (Port 5011)", critical=True, port=5011)
elif os.path.exists("tools/aurora_intelligence_manager.py"):
    start([PYTHON_CMD, "tools/aurora_intelligence_manager.py"],
          "Intelligence Manager (Port 5011)", critical=True, port=5011)
if os.path.exists("aurora_core_service.py"):
    start([PYTHON_CMD, "aurora_core_service.py"],
          "Aurora Core (Port 5012)", critical=True, port=5012)
elif os.path.exists("activate_aurora_core.py"):
    start([PYTHON_CMD, "activate_aurora_core.py"],
          "Aurora Core (Port 5012)", critical=True, port=5012)
if os.path.exists("aurora_intelligence_analyzer.py"):
    start([PYTHON_CMD, "aurora_intelligence_analyzer.py"],
          "Intelligence Analyzer (Port 5013)", port=5013)
if os.path.exists("aurora_pattern_recognition.py"):
    start([PYTHON_CMD, "aurora_pattern_recognition.py"],
          "Pattern Recognition (Port 5014)", port=5014)

# PHASE 3: AUTONOMOUS
print("\n━" * 80)
print("[AGENT] PHASE 3: AUTONOMOUS SYSTEMS")
print("━" * 80)
if os.path.exists("aurora_autonomous_agent.py"):
    start([PYTHON_CMD, "aurora_autonomous_agent.py"],
          "Autonomous Agent (Port 5015)", critical=True, port=5015)
if os.path.exists("aurora_multi_agent.py"):
    start([PYTHON_CMD, "aurora_multi_agent.py"],
          "Multi-Agent System (Port 5016)", port=5016)
if os.path.exists("aurora_autonomous_integration.py"):
    start([PYTHON_CMD, "aurora_autonomous_integration.py"],
          "Autonomous Integration (Port 5017)", port=5017)
if os.path.exists("aurora_autonomous_monitor.py"):
    start([PYTHON_CMD, "aurora_autonomous_monitor.py"],
          "Autonomous Monitor (Port 5018)", port=5018)

# PHASE 4: GRANDMASTER
print("\n━" * 80)
print("⭐ PHASE 4: GRANDMASTER CAPABILITIES")
print("━" * 80)
if os.path.exists("aurora_grandmaster_autonomous_tools.py"):
    start([PYTHON_CMD, "aurora_grandmaster_autonomous_tools.py"],
          "Grandmaster Tools (Port 5019)", port=5019)
if os.path.exists("aurora_grandmaster_skills_registry.py"):
    start([PYTHON_CMD, "aurora_grandmaster_skills_registry.py"],
          "Skills Registry (Port 5020)", port=5020)
if os.path.exists("aurora_ultimate_omniscient_grandmaster.py"):
    start([PYTHON_CMD, "aurora_ultimate_omniscient_grandmaster.py"],
          "Omniscient Mode (Port 5021)", port=5021)

# PHASE 5: ADVANCED TIERS
print("\n━" * 80)
print("[EMOJI]️ PHASE 5: ADVANCED TIER CAPABILITIES")
print("━" * 80)
if os.path.exists("aurora_visual_understanding.py"):
    start([PYTHON_CMD, "aurora_visual_understanding.py"],
          "Visual Understanding (Port 5022, Tier 43)", port=5022)
if os.path.exists("aurora_live_integration.py"):
    start([PYTHON_CMD, "aurora_live_integration.py"],
          "Live Integration (Port 5023, Tier 44)", port=5023)
if os.path.exists("aurora_test_generator.py"):
    start([PYTHON_CMD, "aurora_test_generator.py"],
          "Test Generator (Port 5024, Tier 45)", port=5024)
if os.path.exists("aurora_security_auditor.py"):
    start([PYTHON_CMD, "aurora_security_auditor.py"],
          "Security Auditor (Port 5025, Tier 53)", port=5025)

# PHASE 6: CODE QUALITY
print("\n━" * 80)
print("[DATA] PHASE 6: CODE QUALITY SYSTEMS")
print("━" * 80)
if os.path.exists("aurora_code_quality_enforcer.py"):
    start([PYTHON_CMD, "aurora_code_quality_enforcer.py"],
          "Code Quality Enforcer (Port 5026)", port=5026)
if os.path.exists("aurora_pylint_prevention.py"):
    start([PYTHON_CMD, "aurora_pylint_prevention.py"],
          "Pylint Prevention (Port 5027)", port=5027)

# PHASE 7: WEB SERVICES
print("\n━" * 80)
print("[WEB] PHASE 7: WEB SERVICES")
print("━" * 80)
start("npm run dev" if IS_WINDOWS else ["npm", "run", "dev"], 
      "Backend + Frontend (Port 5000)", shell=IS_WINDOWS, port=5000)
start([PYTHON_CMD, "-m", "aurora_x.bridge.service"],
      "Bridge Service (Port 5001)", port=5001)
start([PYTHON_CMD, "-m", "aurora_x.self_learn_server"],
      "Self-Learning (Port 5002)", port=5002)
if os.path.exists("aurora_chat_server.py"):
    start([PYTHON_CMD, "aurora_chat_server.py", "--port", "5003"], 
          "Chat Server (Port 5003)", port=5003)

luminar_v2 = "tools\\luminar_nexus_v2.py" if IS_WINDOWS else "tools/luminar_nexus_v2.py"
if os.path.exists(luminar_v2.replace("\\", "/")):
    start([PYTHON_CMD, luminar_v2, "api"], 
          "Luminar Dashboard (Port 5005)", port=5005)

# PHASE 8: ORCHESTRATION
print("\n━" * 80)
print("[TARGET] PHASE 8: ORCHESTRATION SYSTEMS")
print("━" * 80)
uam = "tools\\ultimate_api_manager.py" if IS_WINDOWS else "tools/ultimate_api_manager.py"
if os.path.exists(uam.replace("\\", "/")):
    start([PYTHON_CMD, uam, "--autonomous"], 
          "API Manager (Port 5006)", port=5006)

luminar = "tools\\luminar_nexus.py" if IS_WINDOWS else "tools/luminar_nexus.py"
if os.path.exists(luminar.replace("\\", "/")):
    start([PYTHON_CMD, luminar, "monitor"], 
          "Luminar Nexus (Port 5007)", port=5007)

# PHASE 8.5: API POOL
print("\n━" * 80)
print("[WEB] PHASE 8.5: API ORCHESTRATION POOL")
print("━" * 80)
if os.path.exists("aurora_api_gateway.py"):
    start([PYTHON_CMD, "aurora_api_gateway.py"], 
          "API Gateway (Port 5028)", port=5028)
if os.path.exists("aurora_api_load_balancer.py"):
    start([PYTHON_CMD, "aurora_api_load_balancer.py"],
          "API Load Balancer (Port 5029)", port=5029)
if os.path.exists("aurora_api_rate_limiter.py"):
    start([PYTHON_CMD, "aurora_api_rate_limiter.py"],
          "API Rate Limiter (Port 5030)", port=5030)

# PHASE 9: BACKGROUND
print("\n━" * 80)
print("[EMOJI] PHASE 9: BACKGROUND PROCESSES")
print("━" * 80)
if os.path.exists("aurora_deep_system_updater.py"):
    start([PYTHON_CMD, "aurora_deep_system_updater.py"],
          "Deep System Sync (Port 5008)", port=5008)
if os.path.exists("aurora_web_health_monitor.py"):
    start([PYTHON_CMD, "aurora_web_health_monitor.py"],
          "Web Health Monitor (Port 5004)", port=5004)

print("\n" + "=" * 80)
print("[POWER] STARTUP PHASE COMPLETE - Waiting 5 seconds for stabilization...")
print("=" * 80 + "\n")

try:
    time.sleep(5)
except KeyboardInterrupt:
    print("Startup interrupted")

# FINAL DIAGNOSTICS
print("\n" + "=" * 80)
print("[DATA] AURORA NEXUS V3 - COMPREHENSIVE SYSTEM STATUS")
print("=" * 80)

# Check critical systems
print("\n[AURORA] NEXUS V3 MASTER ORCHESTRATOR:")
if check_port(5031):
    print("   ⏳ Port 5031 - Initializing...")
else:
    print("   [OK] Port 5031 - RUNNING | Master Orchestrator ACTIVE")

# Check consciousness & intelligence
print("\n[BRAIN] CONSCIOUSNESS & INTELLIGENCE:")
critical_running = sum(1 for p, _, c in processes if c and p and p.poll() is None)
critical_total = sum(1 for _, _, c in processes if c)
print(f"   {critical_running}/{critical_total} critical systems active")

# Check web services
print("\n[WEB] WEB & API SERVICES:")
web_services = [
    ("Backend + Frontend", 5000),
    ("Bridge Service", 5001),
    ("Self-Learning", 5002),
    ("Chat Server", 5003),
    ("Web Health Monitor", 5004),
    ("Luminar Dashboard", 5005),
    ("API Manager", 5006),
    ("Luminar Nexus", 5007),
    ("Deep System Sync", 5008),
    ("API Gateway", 5028),
    ("API Load Balancer", 5029),
    ("API Rate Limiter", 5030),
]

web_count = 0
for name, port in web_services:
    if not check_port(port):
        print(f"   [OK] {name:30} Port {port}")
        web_count += 1
    else:
        print(f"   ⏳ {name:30} Port {port} - starting...")

# Check all systems
print("\n[POWER] ALL SYSTEMS SUMMARY:")
total = len(processes)
running = sum(1 for p, _, _ in processes if p and p.poll() is None)

print(f"   Total processes spawned: {total}")
print(f"   Currently running: {running}/{total}")
print(f"   Successfully started: {len(successful_starts)}")
print(f"   Failed to start: {len(failed_starts)}")

if failed_starts:
    print(f"\n[ERROR] FAILED SYSTEMS ({len(failed_starts)}):")
    for name, reason in failed_starts:
        print(f"   • {name}: {reason}")

# Final summary
print("\n" + "=" * 80)
print(f"[POWER] AURORA NEXUS V3 STATUS: {running}/{total} systems active")
print(f"[BRAIN] Critical: {critical_running}/{critical_total}")
print(f"[WEB] Web/API: {web_count}/{len(web_services)}")

if running >= total * 0.8 and critical_running >= critical_total * 0.7:
    print("\n" + "=" * 80)
    print("[EMOJI] AURORA NEXUS V3 - SUCCESSFULLY ACTIVATED!")
    print("=" * 80)
    print("\n   [QUALITY] SYSTEM STATUS: OPERATIONAL")
    print("\n   [WEB] ACCESS POINTS:")
    print("      • Frontend:     http://127.0.0.1:5000")
    print("      • Chat:         http://127.0.0.1:5003")
    print("      • Health:       http://127.0.0.1:5004")
    print("      • Dashboard:    http://127.0.0.1:5005")
    print("      • Nexus V3 API: http://127.0.0.1:5031 ⭐")
    print("\n" + "=" * 80)
else:
    print("\n[WARN]  PARTIAL ACTIVATION")
    print(f"   {running}/{total} systems active ({int(running/total*100)}%)")
    if failed_starts:
        print(f"   {len(failed_starts)} systems failed to start (see above)")
    print("   Waiting for full initialization...")

print("\n[POWER] Aurora Nexus V3 - Smart Launcher with Full Diagnostics")
print("=" * 80 + "\n")
