# === Aurora-X Spec â†’ Code + Tests + Discord ===

SPEC ?= specs/rich_spec_v2.md
DISCORD_CLI := tools/discord_cli.py

spec:
	@echo "ðŸ”§ Compiling spec: $(SPEC)"
	@python -m aurora_x.main --spec $(SPEC) || { \
	  python $(DISCORD_CLI) error "âŒ Spec $(SPEC) failed to compile"; exit 1; }

spec-test:
	@echo "ðŸ§ª Running tests for latest run..."
	@latest=$$(ls -dt runs/run-* 2>/dev/null | head -1); \
	if [ -z "$$latest" ]; then echo "No runs found"; exit 1; fi; \
	cd $$latest && PYTHONPATH=$$PWD python -m unittest discover -s tests || { \
	  python $(DISCORD_CLI) error "âŒ Tests failed for $$(basename $$latest)"; exit 1; }

spec-report:
	@latest=$$(ls -dt runs/run-* 2>/dev/null | head -1); \
	if [ -z "$$latest" ]; then echo "No runs found"; exit 1; fi; \
	echo "ðŸ“Š Report: $$latest/report.html"

spec-all:
	@$(MAKE) -f Makefile.aurora spec SPEC=$(SPEC)
	@$(MAKE) -f Makefile.aurora spec-test
	@latest=$$(ls -dt runs/run-* 2>/dev/null | head -1); \
	python $(DISCORD_CLI) success "âœ… Aurora-X: $(SPEC) passed â€” $$(basename $$latest)"