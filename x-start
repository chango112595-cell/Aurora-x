#!/usr/bin/env python3
"""
Aurora-X Start Command (100% Hybrid Mode)
Launches enhanced system with auto-update
"""

import subprocess
import sys
import os
import time
from pathlib import Path

print("\n" + "="*80)
print("üåå AURORA-X: Starting 100% Hybrid Mode with Auto-Update")
print("="*80 + "\n")

# Get script directory
script_dir = Path(__file__).parent
os.chdir(script_dir)

# Check if enhanced x-start exists
enhanced_path = script_dir / "x-start-enhanced"
if not enhanced_path.exists():
    print("‚ùå x-start-enhanced not found!")
    print("   Creating it now...\n")
    
    # Build the enhanced x-start
    build_script = script_dir / "aurora_build_enhanced_xstart.py"
    if build_script.exists():
        try:
            subprocess.run([sys.executable, str(build_script)], check=True)
            print("\n‚úÖ x-start-enhanced created!\n")
        except subprocess.CalledProcessError as e:
            print(f"‚ùå Failed to create x-start-enhanced: {e}")
            sys.exit(1)
    else:
        print("‚ùå aurora_build_enhanced_xstart.py not found!")
        sys.exit(1)

print("üîÑ PHASE 1: Auto-Update Check")
print("‚îÅ" * 80)

<<<<<<< HEAD

# 1. Start Backend + Frontend (npm run dev serves both on port 5000)
print("üöÄ Starting Aurora Backend + Frontend (port 5000)...")
start_process("npm run dev" if IS_WINDOWS else [
              "npm", "run", "dev"], is_shell=IS_WINDOWS)
time.sleep(3)

# 2. Start Bridge Service
print("üöÄ Starting Bridge Service (port 5001)...")
start_process([PYTHON_CMD, "-m", "aurora_x.bridge.service"])
time.sleep(2)

# 3. Start Self-Learning
print("üöÄ Starting Self-Learning Service (port 5002)...")
start_process([PYTHON_CMD, "-m", "aurora_x.self_learn_server"])
time.sleep(2)

# 4. Start Chat Server
print("üöÄ Starting Chat Server (port 5003)...")
start_process([PYTHON_CMD, "aurora_chat_server.py", "--port", "5003"])
time.sleep(2)

# 5. Start Luminar Nexus Dashboard
print("üöÄ Starting Luminar Nexus Dashboard (port 5005)...")
luminar_path = "tools\\luminar_nexus_v2.py" if IS_WINDOWS else "tools/luminar_nexus_v2.py"
start_process([PYTHON_CMD, luminar_path, "api"])
time.sleep(2)

# 6. Start Ultimate API Manager (Master Orchestrator)
print("üéØ Starting Ultimate API Manager (Master Orchestrator)...")
uam_path = "tools\\ultimate_api_manager.py" if IS_WINDOWS else "tools/ultimate_api_manager.py"
start_process([PYTHON_CMD, uam_path, "--autonomous"])
time.sleep(2)

# 7. Start Luminar Nexus (Advanced Orchestration)
print("üåå Starting Luminar Nexus Orchestration...")
luminar_main_path = "tools\\luminar_nexus.py" if IS_WINDOWS else "tools/luminar_nexus.py"
start_process([PYTHON_CMD, luminar_main_path, "monitor"])
time.sleep(2)

# 8. Start Aurora Autonomous Monitor (System Health Monitoring)
print("ü§ñ Starting Aurora Autonomous Monitor...")
start_process([PYTHON_CMD, "aurora_autonomous_monitor.py"])
time.sleep(1)

# 9. Activate Core Aurora Intelligence (if exists)
print("üß† Activating Aurora Core Intelligence...")
if os.path.exists("aurora_core.py"):
    # This loads all integrated autonomous modules
    core_activation_script = os.path.join(
        script_dir, "activate_aurora_core.py")
    if os.path.exists(core_activation_script):
        start_process([PYTHON_CMD, core_activation_script])
time.sleep(1)

# 10. Run Initial System Update (one-time sync on startup) - Run in background to avoid timeout
print("üîÑ Starting DEEP system synchronization...")
print("   (Scans 4000+ files across entire project)")
start_process([PYTHON_CMD, "aurora_deep_system_updater.py"])
print("   ‚è≥ Deep sync running in background (may take 1-2 minutes)")

# Wait for services to initialize
print("\n‚è≥ Waiting for services to fully initialize...")
try:
    time.sleep(10)
except KeyboardInterrupt:
    print("\n‚ö†Ô∏è  Startup interrupted - services may still be starting in background")
    pass

# Check service status


def check_port(port_num):
    """Check if a port is listening."""
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(2)
    try:
        result = sock.connect_ex(('127.0.0.1', port_num))
        sock.close()
        return result == 0
    except (socket.error, KeyboardInterrupt, Exception):
        try:
            sock.close()
        except:
            pass
        return False


print("\nüìä Aurora Service Status:")
print("=" * 60)

services = [
    ("Backend API + Frontend", 5000),
    ("Bridge Service", 5001),
    ("Self-Learning Service", 5002),
    ("Chat Server", 5003),
    ("Luminar Dashboard", 5005),
=======
# Check if auto-update system exists
auto_update_files = [
    "aurora_deep_system_updater.py",
    "aurora_complete_system_update.py",
    "aurora_automatic_system_update.py"
>>>>>>> 315f5cdf027d37d7ae1db5d11342378c39aa92d8
]

auto_update_script = None
for file in auto_update_files:
    if (script_dir / file).exists():
        auto_update_script = file
        break

<<<<<<< HEAD
running_count = 0
try:
    for name, port in services:
        is_running = check_port(port)
        status = "‚úÖ RUNNING" if is_running else "‚ö†Ô∏è  starting..."
        print(f"   {name:25} Port {port:5} {status}")
        if is_running:
            running_count += 1
except KeyboardInterrupt:
    print("\n‚ö†Ô∏è  Service check interrupted")
    pass

print("=" * 60)
print(f"\n{'‚úÖ' if running_count >= 3 else '‚ö†Ô∏è'} {running_count}/{len(services)} services running")

if running_count >= 3:
    print("\nüéâ Aurora is FULLY ACTIVATED!")
    print("   üåê Frontend:  http://localhost:5000")
    print("   üí¨ Chat:      http://localhost:5003")
    print("   üìä Dashboard: http://localhost:5005")
    print("\n   üéØ Orchestration Systems:")
    print("      ‚Ä¢ Ultimate API Manager: RUNNING (Master Orchestrator)")
    print("      ‚Ä¢ Luminar Nexus: RUNNING (Advanced Coordination)")
    print("\n   ü§ñ Autonomous Systems:")
    print("      ‚Ä¢ Autonomous Monitor: RUNNING (24/7 health checks)")
    print("      ‚Ä¢ Autonomous Fixer: RUNNING (auto-fix on detection)")
    print("      ‚Ä¢ System Coordinator: RUNNING (multi-system sync)")
    print("\n   üîÑ Background Processes:")
    print("      ‚Ä¢ Deep System Sync: RUNNING")
    print("      ‚Ä¢ Proactive Error Detection: ENABLED")
    print("      ‚Ä¢ Self-Healing: ENABLED")
    print("\n   Note: Some services may still be initializing.")
    print("   Give them 10-20 more seconds if not all are ready yet.")
=======
if auto_update_script:
    print(f"üîÑ Running auto-update: {auto_update_script}")
    try:
        # Run auto-update in background
        subprocess.Popen(
            [sys.executable, str(script_dir / auto_update_script)],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL
        )
        print("   ‚úÖ Auto-update running in background")
        time.sleep(2)
    except Exception as e:
        print(f"   ‚ö†Ô∏è  Auto-update failed to start: {e}")
>>>>>>> 315f5cdf027d37d7ae1db5d11342378c39aa92d8
else:
    print("   ‚ÑπÔ∏è  No auto-update system found (optional)")

<<<<<<< HEAD
print("\n‚ú® Aurora-X is FULLY OPERATIONAL!")
print("   üí° All 91 orchestrators + 100 autonomous systems are coordinating")
print("   üß† Proactive monitoring: ACTIVE - Aurora will auto-fix issues before you notice")
print("   üîÆ Self-healing, self-optimizing, fully autonomous operation enabled")
=======
print("\nüöÄ PHASE 2: Launching Enhanced System (26 Services)")
print("‚îÅ" * 80)
print("   This will activate all 188 capabilities...")
print("   ‚Ä¢ Consciousness Layer")
print("   ‚Ä¢ Core Intelligence (79 Tiers)")
print("   ‚Ä¢ Autonomous Systems")
print("   ‚Ä¢ Grandmaster Capabilities")
print("   ‚Ä¢ Advanced Tiers")
print("   ‚Ä¢ Code Quality Systems")
print("   ‚Ä¢ Web Services (5 ports)")
print("   ‚Ä¢ Orchestration")
print("   ‚Ä¢ Background Processes\n")

# Launch the enhanced x-start
try:
    subprocess.run([sys.executable, str(enhanced_path)], check=True)
except KeyboardInterrupt:
    print("\n\n‚ö†Ô∏è  Startup interrupted by user")
    sys.exit(0)
except subprocess.CalledProcessError as e:
    print(f"\n‚ùå Enhanced system failed to start: {e}")
    sys.exit(1)
>>>>>>> 315f5cdf027d37d7ae1db5d11342378c39aa92d8
