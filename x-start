#!/usr/bin/env python3
"""
Aurora-X Unified Start Command
Starts all Aurora services
"""

import subprocess
import time
import os
import platform
import socket

print("ğŸŒŒ Aurora: Starting all services...")
print("   This will take a moment as services initialize...\n")

# Get script directory
script_dir = os.path.dirname(os.path.abspath(__file__))
os.chdir(script_dir)

# Detect platform
IS_WINDOWS = platform.system() == "Windows"
PYTHON_CMD = "python" if IS_WINDOWS else "python3"


def start_process(cmd, is_shell=False):
    """Start a process with correct parameters for current platform"""
    kwargs = {
        'stdout': subprocess.DEVNULL,
        'stderr': subprocess.DEVNULL,
    }

    if IS_WINDOWS:
        kwargs['creationflags'] = subprocess.CREATE_NEW_PROCESS_GROUP
        if is_shell:
            kwargs['shell'] = True
    else:
        kwargs['start_new_session'] = True

    return subprocess.Popen(cmd, **kwargs)


# 1. Start Backend + Frontend (npm run dev serves both on port 5000)
print("ğŸš€ Starting Aurora Backend + Frontend (port 5000)...")
start_process("npm run dev" if IS_WINDOWS else [
              "npm", "run", "dev"], is_shell=IS_WINDOWS)
time.sleep(3)

# 2. Start Bridge Service
print("ğŸš€ Starting Bridge Service (port 5001)...")
start_process([PYTHON_CMD, "-m", "aurora_x.bridge.service"])
time.sleep(2)

# 3. Start Self-Learning
print("ğŸš€ Starting Self-Learning Service (port 5002)...")
start_process([PYTHON_CMD, "-m", "aurora_x.self_learn_server"])
time.sleep(2)

# 4. Start Chat Server
print("ğŸš€ Starting Chat Server (port 5003)...")
start_process([PYTHON_CMD, "aurora_chat_server.py", "--port", "5003"])
time.sleep(2)

# 5. Start Luminar Nexus Dashboard
print("ğŸš€ Starting Luminar Nexus Dashboard (port 5005)...")
luminar_path = "tools\\luminar_nexus_v2.py" if IS_WINDOWS else "tools/luminar_nexus_v2.py"
start_process([PYTHON_CMD, luminar_path, "api"])
time.sleep(2)

# 6. Start Aurora Autonomous Monitor (System Health Monitoring)
print("ğŸ¤– Starting Aurora Autonomous Monitor...")
start_process([PYTHON_CMD, "aurora_autonomous_monitor.py"])
time.sleep(1)

# 7. Run Initial System Update (one-time sync on startup) - Run in background to avoid timeout
print("ğŸ”„ Starting DEEP system synchronization...")
print("   (Scans 4000+ files across entire project)")
start_process([PYTHON_CMD, "aurora_deep_system_updater.py"])
print("   â³ Deep sync running in background (may take 1-2 minutes)")

# Wait for services to initialize
print("\nâ³ Waiting for services to fully initialize...")
time.sleep(10)

# Check service status


def check_port(port_num):
    """Check if a port is listening."""
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(2)
    try:
        result = sock.connect_ex(('127.0.0.1', port_num))
        sock.close()
        return result == 0
    except socket.error:
        return False


print("\nğŸ“Š Aurora Service Status:")
print("=" * 60)

services = [
    ("Backend API + Frontend", 5000),
    ("Bridge Service", 5001),
    ("Self-Learning Service", 5002),
    ("Chat Server", 5003),
    ("Luminar Dashboard", 5005),
]

# Note: Autonomous Monitor runs in background (no port check needed)

running_count = 0
for name, port in services:
    is_running = check_port(port)
    status = "âœ… RUNNING" if is_running else "âš ï¸  starting..."
    print(f"   {name:25} Port {port:5} {status}")
    if is_running:
        running_count += 1

print("=" * 60)
print(f"\n{'âœ…' if running_count >= 3 else 'âš ï¸'} {running_count}/{len(services)} services running")

if running_count >= 3:
    print("\nğŸ‰ Aurora is ready!")
    print("   ğŸŒ Frontend:  http://localhost:5000")
    print("   ğŸ’¬ Chat:      http://localhost:5003")
    print("   ğŸ“Š Dashboard: http://localhost:5005")
    print("\n   ğŸ¤– Background Services:")
    print("      â€¢ Autonomous Monitor: Running (24/7 health checks)")
    print("      â€¢ System Auto-Sync: Enabled")
    print("\n   Note: Some services may still be initializing.")
    print("   Give them 10-20 more seconds if not all are ready yet.")
else:
    print("\nâš ï¸  Some services are still starting...")
    if IS_WINDOWS:
        print('   Wait 20 more seconds and check: netstat -ano | findstr "5000 5001 5002 5003 5005"')
    else:
        print("   Wait 20 more seconds and check: netstat -tlnp | grep -E '5000|5001|5002|5003|5005'")

print("\nâœ¨ Aurora-X is running!")
print("   ğŸ’¡ System is now auto-monitoring and will self-heal if issues arise")
