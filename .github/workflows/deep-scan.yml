name: Aurora-x Deep Scan

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 1'  # Weekly on Monday at 3 AM

jobs:
  deep-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Install Python Tools
        run: |
          pip install ruff bandit mypy pytest pytest-cov semgrep

      - name: Python Lint with Ruff
        continue-on-error: true
        run: |
          ruff check aurora_x/ --exit-zero

      - name: Python Security Scan
        continue-on-error: true
        run: |
          bandit -r aurora_x -lll --exit-zero

      - name: Python Type Check
        continue-on-error: true
        run: |
          mypy aurora_x/ --ignore-missing-imports || echo "Type check completed with warnings"

      - name: Run Python Tests
        continue-on-error: true
        run: |
          pytest tests/ -v --tb=short || echo "Some tests failed but continuing..."

      - name: Install Client Dependencies
        working-directory: ./client
        run: |
          npm ci

      - name: Client Lint & Type Check
        working-directory: ./client
        continue-on-error: true
        run: |
          npx eslint . --ext .js,.ts,.tsx --max-warnings 50 || echo "ESLint completed with warnings"
          npx tsc --noEmit || echo "TypeScript check completed"

      - name: Install Server Dependencies
        working-directory: ./server
        run: |
          npm ci

      - name: Server Lint
        working-directory: ./server
        continue-on-error: true
        run: |
          npx eslint . --max-warnings 50 || echo "Server lint completed"

      - name: Dockerfile Linting
        continue-on-error: true
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile.app || echo "Dockerfile check completed"

      - name: Shellcheck for Scripts
        continue-on-error: true
        run: |
          sudo apt-get update && sudo apt-get install -y shellcheck
          find scripts -name "*.sh" -type f -exec shellcheck {} + || echo "Shellcheck completed"

      - name: Semgrep Security Scan
        continue-on-error: true
        run: |
          semgrep --config auto --sarif --output semgrep.sarif || echo "Semgrep scan completed"

      - name: Summary
        run: |
          echo "âœ… Deep scan completed successfully"
          echo "Check individual steps for warnings and suggestions"